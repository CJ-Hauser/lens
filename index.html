<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Homework Solver</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container { max-width: 900px; margin: 0 auto; }
        .header, .bookmarklet-section, .result-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .header h1 { color: #667eea; margin-bottom: 10px; }
        .bookmarklet-button {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            cursor: move;
            transition: transform 0.2s;
        }
        .bookmarklet-button:hover { transform: translateY(-2px); }
        .instructions { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-top: 20px; }
        .instructions li { margin: 10px 0; line-height: 1.6; margin-left: 20px; }
        .result-section { display: none; }
        .result-section.active { display: block; }
        .image-preview { max-width: 100%; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd; }
        .solution { 
            background: #f8f9fa; 
            border-radius: 8px; 
            padding: 20px; 
            line-height: 1.8; 
            white-space: pre-wrap;
            font-size: 16px;
        }
        .loading { text-align: center; padding: 40px; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error { background: #fee; border: 2px solid #fcc; padding: 20px; border-radius: 8px; color: #c33; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö AI Homework Solver</h1>
            <p>High-speed visual problem solving powered by Gemini.</p>
        </div>

        <div class="bookmarklet-section">
            <h2>üîñ Setup</h2>
            <p style="margin: 15px 0; color: #666;">Drag this button to your bookmarks bar:</p>
            
            <a href="javascript:(function(){if(window.hwSolverActive)return;window.hwSolverActive=true;let stream;const solverUrl='https://cj-hauser.github.io/lens/';(async()=>{try{stream=await navigator.mediaDevices.getDisplayMedia({video:true});const overlay=document.createElement('div');overlay.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(102,126,234,0.3);z-index:999999;cursor:crosshair';document.body.appendChild(overlay);const tip=document.createElement('div');tip.style.cssText='position:fixed;top:20px;left:50%;transform:translateX(-50%);background:white;padding:12px 24px;border-radius:30px;box-shadow:0 4px 15px rgba(0,0,0,0.2);z-index:1000000;font-family:sans-serif;font-weight:bold';tip.textContent='‚ú® Hold Shift + Drag to Select';document.body.appendChild(tip);let startX,startY,box;overlay.onmousedown=e=>{if(!e.shiftKey)return;startX=e.clientX;startY=e.clientY;box=document.createElement('div');box.style.cssText='position:fixed;border:2px solid #667eea;background:rgba(102,126,234,0.2);z-index:1000000;pointer-events:none';document.body.appendChild(box)};overlay.onmousemove=e=>{if(!box)return;box.style.left=Math.min(startX,e.clientX)+'px';box.style.top=Math.min(startY,e.clientY)+'px';box.style.width=Math.abs(e.clientX-startX)+'px';box.style.height=Math.abs(e.clientY-startY)+'px'};overlay.onmouseup=async e=>{if(!box)return;const rect=box.getBoundingClientRect();overlay.remove();tip.remove();box.remove();const video=document.createElement('video');video.srcObject=stream;await video.play();const canvas=document.createElement('canvas');canvas.width=rect.width;canvas.height=rect.height;canvas.getContext('2d').drawImage(video,rect.left,rect.top,rect.width,rect.height,0,0,rect.width,rect.height);const base64=canvas.toDataURL('image/png');stream.getTracks().forEach(t=>t.stop());const win=window.open(solverUrl,'_blank');window.addEventListener('message',function h(ev){if(ev.data==='READY'){win.postMessage(base64,'*');window.removeEventListener('message',h);window.hwSolverActive=false}})}}catch(err){window.hwSolverActive=false}})()})();" class="bookmarklet-button">üîç Solve Homework</a>

            <div class="instructions">
                <h3>How to use:</h3>
                <ol>
                    <li>Drag the <strong>Solve Homework</strong> button to your Bookmarks Bar.</li>
                    <li>Go to any site (IXL, Canvas, etc.) and click the bookmark.</li>
                    <li>Select your screen/tab when prompted.</li>
                    <li><strong>Hold Shift</strong> and drag your mouse over the problem.</li>
                    <li>Wait for this tab to open with your answer!</li>
                </ol>
            </div>
        </div>

        <div class="result-section" id="resultSection">
            <h2>Solution</h2>
            <div id="resultContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Waiting for image from bookmarklet...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const POLLINATIONS_API_KEY = 'sk_QhVJoNm1mY2XIAo8MXnwvrCGO4HXvDYw';

        // 1. Tell the opener we are ready
        if (window.opener) {
            window.opener.postMessage('READY', '*');
        }

        // 2. Listen for the image data
        window.addEventListener('message', async (event) => {
            if (typeof event.data !== 'string' || !event.data.startsWith('data:image')) return;

            const base64Image = event.data;
            const resultSection = document.getElementById('resultSection');
            const resultContent = document.getElementById('resultContent');

            resultSection.classList.add('active');
            resultContent.innerHTML = `
                <img src="${base64Image}" class="image-preview">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Gemini is solving your problem...</p>
                </div>
            `;

            await solveWithGemini(base64Image);
        });

        async function solveWithGemini(base64Data) {
            const resultContent = document.getElementById('resultContent');
            const currentImageHtml = `<img src="${base64Data}" class="image-preview">`;

            try {
                const response = await fetch('https://gen.pollinations.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${POLLINATIONS_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gemini-fast',
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    { type: 'image_url', image_url: { url: base64Data } },
                                    { type: 'text', text: 'Solve this problem step-by-step. Be concise but thorough.' }
                                ]
                            }
                        ]
                    })
                });

                if (!response.ok) throw new Error('AI Service Offline');

                const data = await response.json();
                const text = data.choices[0].message.content;

                resultContent.innerHTML = `
                    ${currentImageHtml}
                    <div class="solution">${text}</div>
                `;
            } catch (err) {
                resultContent.innerHTML = `
                    ${currentImageHtml}
                    <div class="error"><strong>Error:</strong> ${err.message}</div>
                `;
            }
        }
    </script>
</body>
</html>
