<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Homework Solver</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .bookmarklet-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .bookmarklet-section h2 {
            font-size: 24px;
            color: #333;
            margin-bottom: 15px;
        }

        .bookmarklet-button {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            cursor: move;
            transition: transform 0.2s;
        }

        .bookmarklet-button:hover {
            transform: translateY(-2px);
        }

        .instructions {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #555;
        }

        .instructions li {
            margin: 10px 0;
            line-height: 1.6;
        }

        .result-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: none;
        }

        .result-section.active {
            display: block;
        }

        .result-section h2 {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
        }

        .image-preview {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .solution {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            border: 2px solid #fcc;
            border-radius: 8px;
            padding: 20px;
            color: #c33;
        }

        .api-info {
            background: #d4edda;
            border: 2px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö AI Homework Solver</h1>
            <p>Select any problem on any website, and get instant AI-powered solutions with Gemini</p>
        </div>

        <div class="bookmarklet-section">
            <h2>üîñ Setup Instructions</h2>
            
            <div class="api-info">
                <strong>‚úÖ Ready to Use - No Setup Required!</strong>
                <p style="margin-top: 8px;">Just drag the bookmarklet and start solving problems instantly!</p>
            </div>

            <div style="margin-top: 30px;">
                <p style="margin-bottom: 15px; color: #555;">Drag this button to your bookmarks bar:</p>
                <a href="javascript:(function(){if(!window.homeworkSolverActive){window.homeworkSolverActive=true;let stream;let captureReady=false;(async()=>{try{stream=await navigator.mediaDevices.getDisplayMedia({video:{mediaSource:'screen'}});await new Promise(resolve=>setTimeout(resolve,500));captureReady=true}catch(err){alert('Screen sharing cancelled: '+err.message);window.homeworkSolverActive=false;return}const overlay=document.createElement('div');overlay.id='hw-solver-overlay';overlay.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(102,126,234,0.3);z-index:999999;cursor:crosshair';document.body.appendChild(overlay);const instruction=document.createElement('div');instruction.style.cssText='position:fixed;top:20px;left:50%;transform:translateX(-50%);background:white;padding:20px 30px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:1000000;font-family:system-ui;font-size:16px;color:#333;font-weight:600';instruction.textContent='‚ú® Hold Shift and drag to select an area';document.body.appendChild(instruction);let startX,startY,selectionBox;overlay.addEventListener('mousedown',e=>{if(!e.shiftKey||!captureReady)return;startX=e.clientX;startY=e.clientY;selectionBox=document.createElement('div');selectionBox.style.cssText='position:fixed;border:3px solid #667eea;background:rgba(102,126,234,0.2);z-index:1000000;pointer-events:none';document.body.appendChild(selectionBox)});overlay.addEventListener('mousemove',e=>{if(!selectionBox||!e.shiftKey)return;const currentX=e.clientX;const currentY=e.clientY;const left=Math.min(startX,currentX);const top=Math.min(startY,currentY);const width=Math.abs(currentX-startX);const height=Math.abs(currentY-startY);selectionBox.style.left=left+'px';selectionBox.style.top=top+'px';selectionBox.style.width=width+'px';selectionBox.style.height=height+'px'});overlay.addEventListener('mouseup',async e=>{if(!selectionBox||!e.shiftKey)return;const rect=selectionBox.getBoundingClientRect();if(rect.width<10||rect.height<10){alert('Selection too small! Please select a larger area.');selectionBox.remove();return}const loadingMsg=document.createElement('div');loadingMsg.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px 40px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:1000001;font-family:system-ui;font-size:18px;color:#333;font-weight:600';loadingMsg.textContent='üì∏ Capturing screenshot...';document.body.appendChild(loadingMsg);overlay.remove();instruction.remove();selectionBox.remove();window.homeworkSolverActive=false;const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');const scale=window.devicePixelRatio||1;canvas.width=rect.width*scale;canvas.height=rect.height*scale;ctx.scale(scale,scale);try{const video=document.createElement('video');video.srcObject=stream;video.play();await new Promise(resolve=>video.onloadedmetadata=resolve);await new Promise(resolve=>setTimeout(resolve,100));ctx.drawImage(video,rect.left,rect.top,rect.width,rect.height,0,0,rect.width,rect.height);stream.getTracks().forEach(track=>track.stop());const base64=canvas.toDataURL('image/png');loadingMsg.textContent='‚úÖ Opening solver...';const solverUrl='https://cj-hauser.github.io/lens/?img='+encodeURIComponent(base64);window.open(solverUrl,'_blank');setTimeout(()=>loadingMsg.remove(),1000)}catch(err){loadingMsg.remove();alert('Screenshot failed: '+err.message);stream?.getTracks().forEach(track=>track.stop());window.homeworkSolverActive=false}})})();}})();" class="bookmarklet-button">üîç Solve Homework</a>
            </div>

            <div class="instructions">
                <h3 style="margin-bottom: 15px; color: #333;">How to use:</h3>
                <ol>
                    <li>Drag the "Solve Homework" button to your bookmarks bar</li>
                    <li>Navigate to any website with a problem (IXL, Khan Academy, etc.)</li>
                    <li>Click the bookmarklet in your bookmarks bar</li>
                    <li>Choose your screen/window to share</li>
                    <li>Hold Shift and drag to select the problem area</li>
                    <li>The solution will open in a new tab automatically!</li>
                </ol>
            </div>
        </div>

        <div class="result-section" id="resultSection">
            <h2>Solution</h2>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        const POLLINATIONS_API_KEY = 'sk_QhVJoNm1mY2XIAo8MXnwvrCGO4HXvDYw';
        const IMGBB_API_KEY = 'b42705170ece739b9fb304ccb3daf53a';

        // Check for base64 image parameter in URL
        const urlParams = new URLSearchParams(window.location.search);
        const base64Image = urlParams.get('img');
        const imageUrl = urlParams.get('image');

        if (base64Image || imageUrl) {
            const resultSection = document.getElementById('resultSection');
            const resultContent = document.getElementById('resultContent');
            
            resultSection.classList.add('active');
            
            if (base64Image) {
                // Show the image immediately
                resultContent.innerHTML = `
                    <img src="${base64Image}" class="image-preview" alt="Problem">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Uploading to ImgBB and analyzing problem...</p>
                    </div>
                `;
                
                // Upload to ImgBB first, then solve
                uploadAndSolve(base64Image);
            } else if (imageUrl) {
                // Direct image URL (fallback)
                resultContent.innerHTML = `
                    <img src="${imageUrl}" class="image-preview" alt="Problem">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Analyzing problem with Gemini AI...</p>
                    </div>
                `;
                solveProblem(imageUrl);
            }
        }

        async function uploadAndSolve(base64Data) {
            const resultContent = document.getElementById('resultContent');
            
            try {
                // Convert base64 to blob
                const response = await fetch(base64Data);
                const blob = await response.blob();
                
                // Upload to ImgBB
                const formData = new FormData();
                formData.append('image', blob);
                
                const uploadResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });
                
                const uploadData = await uploadResponse.json();
                
                if (uploadData.data && uploadData.data.url) {
                    // Now solve with the uploaded URL
                    await solveProblem(uploadData.data.url, base64Data);
                } else {
                    throw new Error('ImgBB upload failed: ' + (uploadData.error?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Upload error:', error);
                // If upload fails, try to solve directly with base64
                resultContent.innerHTML = `
                    <img src="${base64Data}" class="image-preview" alt="Problem">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Analyzing problem with Gemini AI (using local image)...</p>
                    </div>
                `;
                await solveProblemDirect(base64Data);
            }
        }

        async function solveProblem(imageUrl, fallbackBase64) {
            const resultContent = document.getElementById('resultContent');
            
            try {
                // Convert image URL to base64
                const response = await fetch(imageUrl);
                const blob = await response.blob();
                const base64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });

                await solveProblemDirect(base64, imageUrl);
            } catch (error) {
                console.error('Error fetching image:', error);
                if (fallbackBase64) {
                    await solveProblemDirect(fallbackBase64);
                } else {
                    throw error;
                }
            }
        }

        async function solveProblemDirect(base64Data, displayImageUrl) {
            const resultContent = document.getElementById('resultContent');
            const displayImage = displayImageUrl || base64Data;
            
            try {
                // Call Pollinations API with Gemini
                const apiResponse = await fetch('https://gen.pollinations.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${POLLINATIONS_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gemini-fast',
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: base64Data
                                        }
                                    },
                                    {
                                        type: 'text',
                                        text: 'Please solve this problem step by step. Show your work and explain the reasoning clearly. If this is a math problem, show all calculations. If this is a reading comprehension or other subject, provide a thorough answer with explanations.'
                                    }
                                ]
                            }
                        ],
                        max_tokens: 2000
                    })
                });

                if (!apiResponse.ok) {
                    throw new Error(`API error: ${apiResponse.status} ${apiResponse.statusText}`);
                }

                const data = await apiResponse.json();
                const solution = data.choices[0].message.content;

                resultContent.innerHTML = `
                    <img src="${displayImage}" class="image-preview" alt="Problem">
                    <div class="solution">${solution}</div>
                `;
            } catch (error) {
                console.error('Error:', error);
                resultContent.innerHTML = `
                    <img src="${displayImage}" class="image-preview" alt="Problem">
                    <div class="error">
                        <strong>Error:</strong> ${error.message}
                        <br><br>
                        Please try again or check your internet connection.
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
